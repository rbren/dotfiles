<% if (protocol === 'https') { -%>
var HttpClient = require('https');
<% } else { -%>
var HttpClient = require('http');
<% } -%>
<% for (var i = 0; i < endpoints.length; ++i) {                     -%>

exports.<%- endpoints[i].functionName -%> = function(
<%   var addedOne = false                                           -%>
<%   for (var j = 0; j < endpoints[i].inputs.length; ++j) {         -%>
<%     if (!endpoints[i].inputs[j].constant) {                      -%>
<%-      addedOne ? ', ' : ''                                       -%>
<%-      endpoints[i].inputs[j].label                               -%>
<%       addedOne = true;                                           -%>
<%     }                                                            -%>
<%   }                                                              -%>
<%-   addedOne ? ', callback' : 'callback'                          -%>
) {
  var requestOptions = {
    host: '<%- host %>',
    port: <%- protocol === 'https' ? 443 : 80 %>,
    path: '<%- endpoints[i].path %>',
    headers: <%- JSON.stringify(endpoints[i].headers).replace('","', '",\n              "') %>,
    method: '<%- endpoints[i].method %>',
  }
<%  for (var j = 0; j < endpoints[i].inputs.length; ++j) {          -%>
<%    var input = endpoints[i].inputs[j];                           -%>
<%    if (input.method === 'path') {                                -%>
<%-     '  requestOptions.path = requestOptions.path.replace('      -%>
<%-     '\':' + input.label + '\', ' + input.label + ');'            %>
<%    } else if (input.method === 'header') {                       -%>
<%-     '  requestOptions.headers[\'' + input.headerKey + '\'] = '  -%>
<%-     'requestOptions.headers[\'' + input.headerKey + '\']'       -%>
<%-     '.replace(\':' + input.label + '\', ' + input.label + ');'   %>
<%    }                                                             -%>
<%  }                                                               -%>

  var req = HttpClient.request(requestOptions, function(res) {
    res.setEncoding('utf8');
    var data = '';
    res.on('error', function(err) {
      callback(err);
      callback = null;
    });
    res.on('data', function(dataIn) { data += dataIn; });
    res.on('end', function() {
      if (callback) {
<% if (endpoints[i].output.type === 'json') {      -%>
        data = JSON.parse(data);
<% }                                               -%>
        callback(null, data);
      }
    })
  });
<% if (endpoints[i].jsonInputs.length > 0) {                        -%>
  var toSend = {
<%   for (var j = 0; j < endpoints[i].jsonInputs.length; ++j) {     -%>
<%     var input = endpoints[i].jsonInputs[j];                      -%>
<%-    '    \'' + input.label + '\': ' + input.label + ','           %>
<%   }                                                              -%>
  }
  req.write(JSON.stringify(toSend) + '\n');
<% }                                                                -%>
  req.end();
}
<% } -%>
