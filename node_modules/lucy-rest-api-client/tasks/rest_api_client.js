/*
 * rest-api-client
 * http://www.bbrennan.info
 *
 * Copyright (c) 2014 Bobby Brennan
 * Licensed under the MIT license.
 */

'use strict';

var _ = require('underscore');

function camelCase(input) {
    return input.toLowerCase().replace(/[-\s](.)/g, function(match, group1) {
        return group1.toUpperCase();
    });
}

module.exports = function (grunt) {
var FS = require('fs');
var EJS = require('ejs');
  grunt.registerMultiTask('rest_api_client', 'A grunt plugin for generating wrappers around REST API clients', function () {
    console.log('building api client...');
    var input = this.data;
    for (var i = 0; i < input.endpoints.length; ++i) {
      input.endpoints[i].functionName = camelCase(input.endpoints[i].name);
      input.endpoints[i].headers = _.extend({}, input.headers, input.endpoints[i].headers);
      input.endpoints[i].jsonInputs = _.filter(input.endpoints[i].inputs, function(input) {
        return input.method === 'json';
      })
    }
    EJS.renderFile(__dirname + '/templates/node/node.ejs', input, function(err, rendered) {
      console.log('rendered:' + err);
      FS.writeFileSync(input.file, rendered);
    });
  });
};

function camelCase(input) { 
  return input.toLowerCase().replace(/[-\s](.)/g, function(match, group1) {
     return group1.toUpperCase();
  });
}
